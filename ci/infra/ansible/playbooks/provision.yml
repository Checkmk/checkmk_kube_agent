---
- name: "Prepare Provisioning."
  hosts: "{{ run_hosts }}"
  remote_user: "{{ ansible_ssh_remote_user }}"
  tasks:
    - name: "Get Provisioning State."
      ansible.builtin.stat:
        path: /k8s-provisioned
      register: provisioned

## Roles do not support OS yet
# - name: "Provision Base."
#   hosts: "{{ run_hosts }}"
#   remote_user: "{{ ansible_ssh_remote_user }}"
#   become: 'true'
#   roles:
#     - thorian93.common
#     - thorian93.upgrade

- name: "Provision Docker."
  hosts: "{{ run_hosts }}"
  remote_user: "{{ ansible_ssh_remote_user }}"
  become: 'true'
  tasks:
    - name: "Run docker role."
      ansible.builtin.include_role:
        name: geerlingguy.docker
      when: ("docker" in container_runtime) and not provisioned.stat.exists

- name: "Provision containerd."
  hosts: "{{ run_hosts }}"
  remote_user: "{{ ansible_ssh_remote_user }}"
  become: 'true'
  tasks:
    - name: "Run containerd role."
      ansible.builtin.include_role:
        name: geerlingguy.containerd
      when: ("containerd" in container_runtime) and not provisioned.stat.exists

- name: "Provision Kubernetes."
  hosts: "{{ run_hosts }}"
  remote_user: "{{ ansible_ssh_remote_user }}"
  become: 'true'
  tasks:
    - name: "Run kubernetes role."
      ansible.builtin.include_role:
        name: geerlingguy.kubernetes
      when: not provisioned.stat.exists

- name: "Finish Provisioning."
  hosts: "{{ run_hosts }}"
  remote_user: "{{ ansible_ssh_remote_user }}"
  tasks:
    - name: "Set Provisioning Flag."
      ansible.builtin.file:
        path: /k8s-provisioned
        state: touch
